name: Gradle Build, Dockerize & Trivy Scan

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: my-gradle-app        # change if you want
      IMAGE_TAG: ${{ github.sha }}
      IMAGE_REF: my-gradle-app:${{ github.sha }}

    steps:
      # 1. Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Setup JDK for Gradle
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3. Cache Gradle
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Build Gradle project (update task if needed, e.g. bootJar) 
      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew clean build

      # 5. Build Docker image from Dockerfile at repo root
      - name: Build Docker image
        run: |
          docker build -t $IMAGE_REF .

      # (Optional) Push to registry â€“ uncomment & configure if needed
      # - name: Login to Docker registry
      #   run: |
      #     echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
      #
      # - name: Push Docker image
      #   run: |
      #     docker push $IMAGE_REF

      # 6. Trivy image scan - JSON report
      - name: Trivy image scan (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: 'json'
          output: 'trivy-image-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'
          ignore-unfixed: true   # change to false if you want everything
          exit-code: '0'         # set to '1' to fail pipeline on vulns

      # 7. Trivy image scan - HTML report using default template
      - name: Trivy image scan (HTML)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: 'template'
          template: '@$HOME/.local/bin/trivy-bin/contrib/html.tpl'
          output: 'trivy-image-report.html'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW,UNKNOWN'
          ignore-unfixed: true
          exit-code: '0'
          skip-setup-trivy: true   # Trivy already installed in previous step

      # 8. Upload Trivy reports as pipeline artifacts
      - name: Upload Trivy reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-image-reports
          path: |
            trivy-image-report.json
            trivy-image-report.html
